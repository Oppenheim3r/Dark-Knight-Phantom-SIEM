{% extends 'base.html' %}

{% block title %}Alerts - Dark Knight Phantom SIEM{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1 class="page-title">Security Alerts</h1>
        <p class="page-subtitle">Detection alerts with event sequences, tracking data, and MITRE ATT&CK mapping</p>
    </div>
    <div>
        <button class="btn btn-secondary" onclick="loadAlerts()">
            <i class="fas fa-sync-alt"></i> Refresh
        </button>
    </div>
</div>

<!-- Filters -->
<div class="card" style="margin-bottom: 20px;">
    <div class="card-body">
        <div style="display: flex; gap: 12px; align-items: end; flex-wrap: wrap;">
            <div class="form-group" style="margin-bottom: 0; flex: 1; min-width: 150px;">
                <label class="form-label">Severity</label>
                <select class="form-select" id="filter-alert-severity">
                    <option value="">All Severities</option>
                    <option value="CRITICAL">Critical</option>
                    <option value="HIGH">High</option>
                    <option value="MEDIUM">Medium</option>
                    <option value="LOW">Low</option>
                </select>
            </div>
            <div class="form-group" style="margin-bottom: 0; flex: 1; min-width: 150px;">
                <label class="form-label">Status</label>
                <select class="form-select" id="filter-alert-status">
                    <option value="">All Status</option>
                    <option value="NEW">New</option>
                    <option value="INVESTIGATING">Investigating</option>
                    <option value="RESOLVED">Resolved</option>
                    <option value="FALSE_POSITIVE">False Positive</option>
                </select>
    </div>
            <div class="form-group" style="margin-bottom: 0; flex: 1; min-width: 150px;">
                <label class="form-label">Category</label>
                <select class="form-select" id="filter-alert-category">
                    <option value="">All Categories</option>
                    <option value="AUTHENTICATION">Authentication</option>
                    <option value="PRIVILEGE_ESCALATION">Privilege Escalation</option>
                    <option value="LATERAL_MOVEMENT">Lateral Movement</option>
                    <option value="PERSISTENCE">Persistence</option>
                    <option value="DEFENSE_EVASION">Defense Evasion</option>
                    <option value="CREDENTIAL_ACCESS">Credential Access</option>
                    <option value="EXECUTION">Execution</option>
                </select>
    </div>
            <button class="btn btn-primary" onclick="loadAlerts()">
                <i class="fas fa-search"></i> Filter
            </button>
    </div>
    </div>
</div>

<!-- Alerts List -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Active Alerts</h3>
    </div>
    <div class="card-body" id="alerts-container">
        <div style="text-align: center; padding: 40px; color: var(--text-muted);">
            <div class="loading-spinner"></div>
            <p style="margin-top: 10px;">Loading alerts...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    async function loadAlerts() {
        try {
            // Get alerts with filters
            const severity = document.getElementById('filter-alert-severity').value;
            const status = document.getElementById('filter-alert-status').value;
            const category = document.getElementById('filter-alert-category').value;
            
            const params = new URLSearchParams();
            if (severity) params.append('severity', severity);
            if (status) params.append('status', status);
            if (category) params.append('rule__category', category);
            
            const alertsResponse = await fetch(`${API_BASE}/detection/alerts/?${params.toString()}`);
            const alertsData = await alertsResponse.json();
            const alerts = alertsData.results || alertsData;
            
            const container = document.getElementById('alerts-container');
            
            if (alerts.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px; color: var(--text-muted);">
                        <i class="fas fa-check-circle" style="font-size: 48px; margin-bottom: 16px; color: var(--status-low);"></i>
                        <h3>No Active Alerts</h3>
                        <p>Your environment is looking good!</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            alerts.forEach(alert => {
                const triggered = new Date(alert.triggered_at).toLocaleString();
                const severityClass = (alert.severity || 'MEDIUM').toLowerCase();
                const statusClass = (alert.status || 'NEW').toLowerCase();
                
                // Extract detection logic data
                const evidence = alert.evidence || {};
                const ruleLogic = alert.rule_logic || {};
                const eventCounts = evidence.event_counts || {};
                const uniqueValues = evidence.unique_values || {};
                const windowMinutes = evidence.window_minutes || ruleLogic.window_minutes || 0;
                const ruleType = alert.rule_category || 'UNKNOWN';
                const mitreTactic = alert.rule?.mitre_tactic || '';
                const mitreTechnique = alert.rule?.mitre_technique || '';
                
                // Build event counts breakdown
                let eventCountsHtml = '';
                if (Object.keys(eventCounts).length > 0) {
                    eventCountsHtml = '<div style="margin-top: 12px;"><strong style="color: var(--accent-purple);">Event Breakdown:</strong><div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 8px; margin-top: 8px;">';
                    Object.entries(eventCounts).forEach(([eid, count]) => {
                        const eventName = getEventName(eid);
                        eventCountsHtml += `
                            <div style="padding: 8px; background: var(--background-dark); border-radius: 4px; border-left: 3px solid var(--accent-purple);">
                                <div style="font-size: 11px; color: var(--text-muted);">Event ${eid}</div>
                                <div style="font-weight: 600; color: var(--accent-cyan);">${count}</div>
                                <div style="font-size: 10px; color: var(--text-muted);">${eventName}</div>
                            </div>
                        `;
                    });
                    eventCountsHtml += '</div></div>';
                }
                
                // Build unique values display
                let uniqueValuesHtml = '';
                if (Object.keys(uniqueValues).length > 0) {
                    uniqueValuesHtml = '<div style="margin-top: 12px;"><strong style="color: var(--accent-purple);">Unique Values Tracked:</strong><div style="margin-top: 8px;">';
                    Object.entries(uniqueValues).forEach(([field, values]) => {
                        const valList = Array.isArray(values) ? values : [values];
                        uniqueValuesHtml += `
                            <div style="margin-bottom: 8px; padding: 8px; background: var(--background-dark); border-radius: 4px;">
                                <strong style="color: var(--accent-cyan); font-size: 12px;">${field}:</strong>
                                <div style="display: flex; flex-wrap: wrap; gap: 4px; margin-top: 4px;">
                                    ${valList.slice(0, 10).map(v => `<span style="padding: 2px 6px; background: var(--accent-purple); border-radius: 3px; font-size: 11px;">${escapeHtml(String(v))}</span>`).join('')}
                                    ${valList.length > 10 ? `<span style="color: var(--text-muted); font-size: 11px;">+${valList.length - 10} more</span>` : ''}
                                </div>
                            </div>
                        `;
                    });
                    uniqueValuesHtml += '</div></div>';
                }
                
                // Build sequence display if SEQUENCE rule
                let sequenceHtml = '';
                if (ruleLogic.sequence && Array.isArray(ruleLogic.sequence)) {
                    sequenceHtml = '<div style="margin-top: 12px;"><strong style="color: var(--accent-purple);">Event Sequence Detected:</strong><div style="display: flex; align-items: center; gap: 8px; margin-top: 8px; flex-wrap: wrap;">';
                    ruleLogic.sequence.forEach((step, idx) => {
                        const eids = step.event_ids || [step.event_id];
                        const count = step.count || 1;
                        sequenceHtml += `
                            <div style="padding: 8px 12px; background: var(--background-dark); border-radius: 4px; border: 1px solid var(--accent-purple);">
                                <div style="font-size: 11px; color: var(--text-muted);">Step ${idx + 1}</div>
                                <div style="font-weight: 600;">Event ${eids.join('/')} × ${count}</div>
                            </div>
                        `;
                        if (idx < ruleLogic.sequence.length - 1) {
                            sequenceHtml += '<i class="fas fa-arrow-right" style="color: var(--accent-purple);"></i>';
                        }
                    });
                    sequenceHtml += '</div></div>';
                }
                
                // Build correlation display if CORRELATION rule
                let correlationHtml = '';
                if (ruleLogic.required_events && Array.isArray(ruleLogic.required_events)) {
                    correlationHtml = '<div style="margin-top: 12px;"><strong style="color: var(--accent-purple);">Correlated Events Required:</strong><div style="display: flex; flex-wrap: wrap; gap: 4px; margin-top: 8px;">';
                    ruleLogic.required_events.forEach(eid => {
                        const hasEvent = eventCounts[String(eid)] > 0;
                        correlationHtml += `
                            <span style="padding: 4px 8px; background: ${hasEvent ? 'var(--accent-purple)' : 'var(--background-dark)'}; border-radius: 4px; font-size: 11px; border: 1px solid ${hasEvent ? 'var(--accent-cyan)' : 'var(--border-color)'};">
                                Event ${eid} ${hasEvent ? '✓' : '✗'}
                            </span>
                        `;
                    });
                    correlationHtml += '</div></div>';
                }
                
                // Build pattern display if PATTERN rule
                let patternHtml = '';
                if (ruleLogic.patterns && Object.keys(ruleLogic.patterns).length > 0) {
                    patternHtml = '<div style="margin-top: 12px;"><strong style="color: var(--accent-purple);">Pattern Matches:</strong><div style="margin-top: 8px;">';
                    Object.entries(ruleLogic.patterns).forEach(([field, patterns]) => {
                        const patternList = Array.isArray(patterns) ? patterns : [patterns];
                        patternHtml += `
                            <div style="margin-bottom: 8px; padding: 8px; background: var(--background-dark); border-radius: 4px;">
                                <strong style="color: var(--accent-cyan); font-size: 12px;">${field}:</strong>
                                <div style="margin-top: 4px; font-family: monospace; font-size: 11px; color: var(--text-secondary);">
                                    ${patternList.map(p => `"${escapeHtml(String(p))}"`).join(' OR ')}
                                </div>
                            </div>
                        `;
                    });
                    patternHtml += '</div></div>';
                }
                
                html += `
                    <div class="alert-card" style="margin-bottom: 24px; padding: 20px; border: 2px solid var(--border-color); border-radius: 12px; background: var(--background-card); border-left: 4px solid var(--status-${severityClass});">
                        <!-- Alert Header -->
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px; flex-wrap: wrap; gap: 12px;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px; flex-wrap: wrap;">
                                    <span class="severity-badge ${severityClass}" style="padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 700;">${alert.severity}</span>
                                    <span class="status-badge ${statusClass}" style="padding: 6px 12px; border-radius: 6px; font-size: 12px; background: var(--text-muted);">${alert.status}</span>
                                    <span style="padding: 6px 12px; background: var(--accent-purple); border-radius: 6px; font-size: 12px; font-weight: 600;">
                                        <i class="fas fa-shield-halved"></i> ${alert.rule_name || 'Unknown Rule'}
                                    </span>
                                    <span style="padding: 6px 12px; background: var(--background-dark); border-radius: 6px; font-size: 12px;">
                                        <i class="fas fa-chart-line"></i> Confidence: ${alert.confidence || 0}%
                            </span>
                                </div>
                                <h3 style="margin: 0; color: var(--text-primary); font-size: 18px;">${alert.title || 'Untitled Alert'}</h3>
                                <p style="margin: 8px 0 0 0; color: var(--text-secondary);">${alert.description || 'No description'}</p>
                            </div>
                            <div style="text-align: right;">
                                <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 4px;">Triggered</div>
                                <div style="color: var(--text-primary); font-weight: 600;">${triggered}</div>
                            </div>
                        </div>
                        
                        <!-- MITRE ATT&CK Info -->
                        ${mitreTactic ? `
                        <div style="padding: 12px; background: linear-gradient(135deg, var(--accent-purple), var(--accent-cyan)); border-radius: 8px; margin-bottom: 16px;">
                            <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                                <div>
                                    <div style="font-size: 11px; color: rgba(255,255,255,0.8);">MITRE ATT&CK</div>
                                    <div style="font-weight: 700; color: white;">${mitreTactic}</div>
                                </div>
                                ${mitreTechnique ? `<div style="padding: 4px 8px; background: rgba(255,255,255,0.2); border-radius: 4px; font-family: monospace; font-size: 12px; color: white;">${mitreTechnique}</div>` : ''}
                                <div style="margin-left: auto; padding: 4px 8px; background: rgba(255,255,255,0.2); border-radius: 4px; font-size: 11px; color: white;">
                                    <i class="fas fa-tag"></i> ${ruleType.replace('_', ' ')}
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Entity Information -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 16px; padding: 16px; background: var(--background-dark); border-radius: 8px;">
                            <div>
                                <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;"><i class="fas fa-desktop"></i> Hostname</div>
                                <div style="font-weight: 600; color: var(--accent-cyan);">${alert.hostname || 'N/A'}</div>
                            </div>
                            ${alert.user_name ? `
                            <div>
                                <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;"><i class="fas fa-user"></i> User</div>
                                <div style="font-weight: 600; color: var(--accent-cyan);">${escapeHtml(alert.user_name)}</div>
                            </div>
                            ` : ''}
                            ${alert.source_ip ? `
                            <div>
                                <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;"><i class="fas fa-network-wired"></i> Source IP</div>
                                <div style="font-weight: 600; color: var(--accent-cyan);">${alert.source_ip}</div>
                            </div>
                            ` : ''}
                            <div>
                                <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;"><i class="fas fa-hashtag"></i> Total Events</div>
                                <div style="font-weight: 600; color: var(--accent-cyan);">${alert.event_count || 0}</div>
                            </div>
                            ${windowMinutes > 0 ? `
                            <div>
                                <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;"><i class="fas fa-clock"></i> Time Window</div>
                                <div style="font-weight: 600; color: var(--accent-cyan);">${windowMinutes} minutes</div>
                            </div>
                            ` : ''}
                            ${alert.first_event_time ? `
                            <div>
                                <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;"><i class="fas fa-calendar-start"></i> First Event</div>
                                <div style="font-weight: 600; color: var(--accent-cyan); font-size: 11px;">${new Date(alert.first_event_time).toLocaleString()}</div>
                            </div>
                            ` : ''}
                            ${alert.last_event_time ? `
                            <div>
                                <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;"><i class="fas fa-calendar-check"></i> Last Event</div>
                                <div style="font-weight: 600; color: var(--accent-cyan); font-size: 11px;">${new Date(alert.last_event_time).toLocaleString()}</div>
                        </div>
                            ` : ''}
                        </div>
                        
                        <!-- Detection Logic Details -->
                        ${eventCountsHtml}
                        ${sequenceHtml}
                        ${correlationHtml}
                        ${patternHtml}
                        ${uniqueValuesHtml}
                        
                        <!-- Matched Event IDs -->
                        ${alert.matched_events && alert.matched_events.length > 0 ? `
                        <div style="margin-top: 16px; padding: 16px; background: var(--background-dark); border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <strong style="color: var(--accent-purple); font-size: 14px;">
                                    <i class="fas fa-scroll"></i> Matched Event IDs (${alert.matched_events.length})
                                </strong>
                                <button class="btn btn-secondary" style="padding: 4px 12px; font-size: 11px;" onclick="viewAlertEvents('${alert.id}')">
                                    View All Events
                            </button>
                            </div>
                            <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                                ${alert.matched_events.slice(0, 30).map(eid => `
                                    <span style="padding: 4px 8px; background: var(--accent-purple); border-radius: 4px; font-size: 11px; font-family: monospace; cursor: pointer;" 
                                          onclick="window.location.href='/events/?event_id=${eid}'" 
                                          title="Click to view event">
                                        ${eid}
                                    </span>
                                `).join('')}
                                ${alert.matched_events.length > 30 ? `<span style="color: var(--text-muted); font-size: 11px; padding: 4px 8px;">+${alert.matched_events.length - 30} more</span>` : ''}
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Actions -->
                        <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border-color); display: flex; gap: 8px; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="showAlertDetails('${alert.id}')">
                                <i class="fas fa-eye"></i> View Full Details
                            </button>
                            ${alert.matched_events && alert.matched_events.length > 0 ? `
                            <button class="btn btn-secondary" onclick="viewAlertEvents('${alert.id}')">
                                <i class="fas fa-scroll"></i> View Events (${alert.matched_events.length})
                            </button>
                            ` : ''}
                            ${alert.status === 'NEW' ? `
                            <button class="btn btn-secondary" onclick="updateAlertStatus('${alert.id}', 'INVESTIGATING')">
                                <i class="fas fa-search"></i> Acknowledge
                            </button>
                            ` : ''}
                            ${alert.status !== 'RESOLVED' && alert.status !== 'FALSE_POSITIVE' ? `
                            <button class="btn btn-secondary" onclick="updateAlertStatus('${alert.id}', 'RESOLVED')">
                                <i class="fas fa-check-circle"></i> Resolve
                            </button>
                            <button class="btn btn-secondary" onclick="updateAlertStatus('${alert.id}', 'FALSE_POSITIVE')">
                                <i class="fas fa-times-circle"></i> False Positive
                            </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
        } catch (error) {
            console.error('Error loading alerts:', error);
            document.getElementById('alerts-container').innerHTML = `
                <div style="padding: 20px; color: var(--status-critical);">
                    <h4>Error loading alerts</h4>
                    <p>${escapeHtml(error.message)}</p>
                </div>
            `;
        }
    }
    
    function getEventName(eventId) {
        const eventNames = {
            4624: 'Successful Logon',
            4625: 'Failed Logon',
            4634: 'Logoff',
            4648: 'Explicit Credential Logon',
            4672: 'Special Privileges Assigned',
            4688: 'Process Creation',
            4698: 'Scheduled Task Created',
            4720: 'User Account Created',
            4728: 'Member Added to Security Group',
            4732: 'Member Added to Local Group',
            4740: 'Account Locked Out',
            4756: 'Member Added to Universal Group',
            4769: 'Kerberos TGS Request',
            5140: 'Network Share Accessed',
            7045: 'Service Installed',
            1102: 'Security Log Cleared',
            5001: 'Windows Defender Disabled',
            4104: 'PowerShell Script Block',
            4103: 'PowerShell Command',
        };
        return eventNames[parseInt(eventId)] || 'Windows Event';
    }
    
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    async function updateAlertStatus(alertId, status) {
        try {
            const response = await fetch(`${API_BASE}/detection/alerts/${alertId}/update_status/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: status })
            });
            
            if (response.ok) {
            loadAlerts();
            } else {
                const error = await response.json();
                alert('Error updating alert: ' + (error.message || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error updating alert status:', error);
            alert('Error updating alert status: ' + error.message);
        }
    }
    
    async function showAlertDetails(alertId) {
        if (typeof showAlertDialog === 'function') {
            showAlertDialog(alertId);
        } else {
            alert('Alert detail view not available');
        }
    }
    
    async function viewAlertEvents(alertId) {
        try {
            const response = await fetch(`${API_BASE}/detection/alerts/${alertId}/`);
            const alert = await response.json();
            
            if (!alert.matched_events || alert.matched_events.length === 0) {
                alert('No events associated with this alert');
                return;
            }
            
            // Navigate to events page with filter for these event IDs
            const eventIds = alert.matched_events.slice(0, 50).join(',');
            window.location.href = `/events/?event_id=${eventIds}`;
        } catch (error) {
            console.error('Error loading alert events:', error);
            alert('Error loading alert events: ' + error.message);
        }
    }
    
    document.addEventListener('DOMContentLoaded', loadAlerts);
    document.getElementById('filter-alert-severity').addEventListener('change', loadAlerts);
    document.getElementById('filter-alert-status').addEventListener('change', loadAlerts);
    document.getElementById('filter-alert-category').addEventListener('change', loadAlerts);
</script>
{% endblock %}
